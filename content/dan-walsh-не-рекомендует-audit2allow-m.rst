.. title: Dan Walsh не рекомендует - "audit2allow -M"
.. slug: dan-walsh-не-рекомендует-audit2allow-m
.. date: 2014-09-09 14:29:19
.. tags: selinux, security, docker, android
.. category: начинающим
.. link:
.. description:
.. type: text
.. author: Peter Lemenkov

Dan продолжает рассказывать о тонкостях настройки SELinux.

Можно выделить несколько уровней для пользователей SELinux. В самом низу,
конечно, уровень "волосатый дикарь-троглодит" - это тот, кто всерьез использует
дистрибутив без SELinux, либо отключает его. Потом идет "полуграмотный варвар"
- тот, кто переводит в permissive. Затем средневековый крестоносец - тот, кто
осилил *cat /var/log/messages \| audit2allow -M myrule && semodule -i
myrule.pp*, и вот только потом начинается `Великая индустриальная революция
<https://ru.wikipedia.org/wiki/Промышленная_революция>`__. Как раз встать на
путь к индустриальной революции и помогает нам Dan.

В `своей заметке <https://danwalsh.livejournal.com/69958.html>`__ Dan вновь
рассматривает типичную ситуацию - SELinux блокирует процессу доступ к файлу.
Эта задача имеет три варианта решения:

#. Изменить метку SELinux у файла.

#. Выставить с помощью setsebool флаг для процесса, если этот флаг есть
   в правилах.

#. Воспользоваться приведенным выше однострочником с *audit2allow*.

Пользователи уровня средневекового крестоносца выбирают третий вариант, и, к
сожалению, он наименее рекомендуемый. В RHEL7 и последних версиях Fedora
утилита *audit2allow* будет предлагать выставить флаг с помощью setsebool, если
это возможно, но пользователи часто не обращают внимания на это предупреждение.

Проблема с трюком *audit2allow* состоит в том, что мы разрешаем некоему
процессу доступ к файлам, маркированным базовыми метками SELinux, например
*etc\_t* или *usr\_t*,. А это значит, что взломанный процесс, имеющий доступ к
таким файлам, может воздействовать на другие процессы, которым нужно читать
данные из /etc или запускать что-то из /usr.

В Fedora и RHEL7 была добавлена возможность просматривать списки базовых типов.
Например, с помощью команды *seinfo -abase\_ro\_file\_type -x* и *seinfo
-abase\_file\_type -x* (утилита из пакета *setools-console*). Если вы
используете *audit2allow*, чтобы позволить процессу иметь доступ к файл/файдам,
маркированным одним из этих типов, то скорее всего вы что-то делаете не то.

.. image:: http://static.fjcdn.com/pictures/Human+I+require+your+assistance+.+Halp+me+plz_7d4ba5_5020679.jpg
   :align: center
   :width: 360px

.. class:: align-center

**Использовал *audit2allow*, и сначала всё было хорошо.**

В данном случае лучше использовать первые два варианта решения, например
сменить тип файла/файлов. Довольно трудный вопрос, это то, на какой тип
поменять то? Были добавлены ряд новых типов, которые перечисляются, например в
`*man httpd\_selinux* <http://linux.die.net/man/8/httpd_selinux>`__. Так же был
разработан новый графический интерфейс, *sepolicy gui*.

Конечно, Dan всегда готов выслушать любые конструктивные предложения, как по
добавлению новых типов, так и по модификации существующих. У него богатый опыт
оптимизации SELinux для конкретного поля задач.  Например, `совсем недавно он
занимался оптимизацией и созданием правил SELinux для Docker
</content/docker-и-selinux>`__, о чем вкратце рассказал в своем `интервью
<http://sdtimes.com/red-hat-open-source-community-fortifying-docker/>`__.

И напоследок хотелось бы рассказать об интересном выступлении. Успех SELinux на
фоне конкурирующих решений, закономерно привел к его включению в Android, о чем
мы, разумеется, `с радостью сообщали
</content/selinux-halloween-release-и-selinux-в-android>`__.  О том, как идут
дела за последний год `рассказал <https://lwn.net/Articles/609511/>`__ на
`Linux Security Summit 2014
<http://kernsec.org/wiki/index.php/Linux_Security_Summit_2014>`__ инженер NSA,
`Stephen Smalley
<http://www.internetsociety.org/who-we-are/speaker-biography/stephen-smalley>`__.

.. image:: https://lwn.net/images/2014/lss-smalley.jpg
   :align: center
   :width: 336px

.. class:: align-center

**Типичный американский ФСБшник, Stephen Smalley**
