.. title: Новый демон D-Bus
.. slug: novyi-demon-d-bus
.. date: 2017-09-01 21:07:56 UTC+03:00
.. tags: kdbus, systemd
.. category: 
.. link: 
.. description: 
.. type: text
.. author: Peter Lemenkov

Продолжается история замены штатного и порядком устаревшего сервиса D-Bus.
После того, `как не взлетел проект kdbus
</content/Неожиданно-отключили-kdbus-в-fedora/>`_, а `перспективы bus1 по
включению в ядро и не просматриваются </content/Новости-systemdlinux/>`_, было
принято решение переписать имеющийся демон.

`David Herrmann <http://dvdhrm.wordpress.com/about-me/>`_ на днях `предложил
<https://dvdhrm.github.io/rethinking-the-dbus-message-bus/>`_ первый вариант
новой реализации - `dbus-broker <https://github.com/bus1/dbus-broker>`_.

Почему понадобилось переписывать начисто, вместо патчей к старой версии,
которой, кстати, больше 15 лет, и как то ведь оно работает. Потому что, при
всем уважении к разработчикам первой реализации, она была спроектирована не
очень хорошо. Этому есть объяснение - было сложно увидеть общую схему
взаимодействия приложений в то время. Поэтому архитектура получилась
гродомздкой, реализация вышла неторопливой, а неизбежная сложность `привела к
увеличивающейся горе ошибок
<https://bugs.freedesktop.org/buglist.cgi?bug_status=__open__&product=dbus&query_format=advanced&order=changeddate%2Cbug_status%2Cpriority%2Cassigned_to%2Cbug_id&query_based_on=>`_,
некоторым из которых уже по 7 лет. Багрепорты варьируются, как указывает David,
от ошибок обращения к памяти, до молчаливой потери сообщений и вызванных
недостатками архитектуры дедлоков. Решить некоторые из этих проблем можно, но
результат не будет соответствовать техническому заданию.

Поэтому было решено переписать брокер сообщений заново, внеся ряд важных
архитектурных изменений:

* Вместо концепции общей шины данных, была реализована концепция отдельных
  узлов, которые независимо друг от друга общаются.

* Демон не использует сеть или другие IPC. Раньше это вызывало дедлоки,
  например, когда `пользователи заведены в LDAP или NIS
  <https://bugs.freedesktop.org/show_bug.cgi?id=28355>`_.

* Все ресурсы учитываются не по отдельным узлам, а по пользователям,
  инициировавшим соединения.

* О каждой ошибке теперь будет сообщаться. Если уведомить пользователя
  невозможно, то демон будет завершать работу аварийно.

В результате получился довольно простой локальный брокер сообщений (не работает
по сети, другой шине, или через libastral), который использует только самые
последний Linux-технологии, работает полностью в пространстве пользователя, и
который довольно хорошо совместим с предыдущей референсной реализацией.
Коллеги-аналитики уже анонимно обсуждают увиденное на `Linux.org.ru
<https://www.linux.org.ru/news/kernel/13633590>`_ и `OpenNET.ru
<https://www.opennet.ru/opennews/art.shtml?num=47071>`_.

Пока непонятно, каково будущее у `bus1 <https://github.com/bus1/bus1>`_, если
реализация шины в userspace будет успешно работать.
